name: Claude PR Review

on:
  # Direct trigger for PRs in this (.github) repository
  issue_comment:
    types: [created]

  # Reusable workflow trigger for other repositories in the organization
  workflow_call:
    secrets:
      ANTHROPIC_API_KEY:
        required: true
        description: Anthropic API key for Claude API access
      LINEAR_API_KEY:
        required: true
        description: Linear API key for issue context retrieval
      GH_MCP_TOKEN:
        required: false
        description: GitHub token for cross-repository context via GitHub MCP server (falls back to GITHUB_TOKEN if not provided)
      CLAUDE_APP_PRIVATE_KEY:
        required: false
        description: GitHub App private key for posting reviews as Claude[bot] (falls back to GITHUB_TOKEN if not provided)
      # GITHUB_TOKEN is automatically provided by GitHub Actions and doesn't need to be defined

# Note: Concurrency control is handled by the caller workflow
# (github.event.issue.number is not available in workflow_call context)

permissions:
  contents: read
  issues: write
  pull-requests: write
  id-token: write

jobs:
  claude-review:
    # When triggered directly (issue_comment): check for @claude in comment
    # When called as reusable workflow (workflow_call): caller already filtered, so run unconditionally
    # SECURITY NOTE: We check comment.body in the if condition, but never pass it to shell
    if: |
      github.event_name == 'workflow_call' ||
      (github.event.issue.pull_request && contains(github.event.comment.body, '@claude'))

    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Validate commenter is org member
        id: validate
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              // Check if commenter is org member or repo collaborator
              // SECURITY: All data here is handled by GitHub Actions script, not shell
              const commenter = context.payload.comment.user.login;
              const repo = context.repo;

              // Try org membership first
              try {
                await github.rest.orgs.checkMembershipForUser({
                  org: repo.owner,
                  username: commenter,
                });
                console.log(`âœ“ ${commenter} is organization member`);
                return true;
              } catch (orgError) {
                // Not an org member, check if repo collaborator
                const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                  owner: repo.owner,
                  repo: repo.repo,
                  username: commenter,
                });

                if (['write', 'admin', 'maintain'].includes(permission.permission)) {
                  console.log(`âœ“ ${commenter} is repository collaborator with ${permission.permission} access`);
                  return true;
                }

                console.log(`âœ— ${commenter} does not have sufficient permissions`);
                return false;
              }
            } catch (error) {
              console.error('Permission check failed:', error);
              return false;
            }

      - name: Generate GitHub App token
        id: app-token
        if: vars.CLAUDE_APP_ID != '' && (secrets.CLAUDE_APP_PRIVATE_KEY != '' || github.event_name == 'workflow_call')
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.CLAUDE_APP_ID }}
          private-key: ${{ secrets.CLAUDE_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Post permission denied message
        if: steps.validate.outputs.result == 'false'
        uses: actions/github-script@v7
        with:
          # Use App token if available, fall back to GITHUB_TOKEN
          github-token: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'âš ï¸ Claude reviews are only available to organization members and repository collaborators with write access.'
            });

      - name: Exit if permission denied
        if: steps.validate.outputs.result == 'false'
        run: exit 0

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Checkout .github repository for review standards
        uses: actions/checkout@v4
        with:
          repository: quantivly/.github
          path: .github-org
          sparse-checkout: |
            docs/review-standards.md
            CLAUDE.md
          fetch-depth: 1

      - name: Extract reviewer instructions
        id: instructions
        uses: actions/github-script@v7
        with:
          script: |
            // Extract custom instructions from @claude comment
            // e.g., "@claude focus on security" -> "focus on security"
            const commentBody = context.payload.comment?.body || '';
            const match = commentBody.match(/@claude\b[,:]?\s*(.*)/is);

            if (!match) {
              core.setOutput('custom_instructions', '');
              return;
            }

            let instructions = match[1].trim();

            // Filter out generic triggers
            const genericTriggers = [
              '', 'review', 'please review', 'review this',
              'please review this', 'review this pr',
              'please review this pr', 'check this', 'please check this'
            ];

            if (genericTriggers.includes(instructions.toLowerCase())) {
              core.setOutput('custom_instructions', '');
              return;
            }

            // Truncate to prevent prompt stuffing
            if (instructions.length > 2000) {
              instructions = instructions.substring(0, 2000) + '... (truncated)';
            }

            console.log(`Custom instructions: ${instructions.substring(0, 100)}...`);
            core.setOutput('custom_instructions', instructions);

      - name: Extract Linear issue ID
        id: linear
        uses: actions/github-script@v7
        with:
          script: |
            // Get PR title to extract Linear ID
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const match = pr.title.match(/^([A-Z]+-\d+)/);
            if (match) {
              core.setOutput('linear_id', match[1]);
              console.log(`Linear issue: ${match[1]}`);
            } else {
              core.setOutput('linear_id', '');
              console.log('No Linear issue ID in PR title');
            }

      - name: Post review started message
        uses: actions/github-script@v7
        with:
          # Use App token if available, fall back to GITHUB_TOKEN
          github-token: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ðŸ¤– Claude review started... This typically takes 2-5 minutes.\n\n_Analyzing code for security, logic errors, code quality, testing, and performance._'
            });

      - name: Create MCP config file
        id: mcp-config
        env:
          # SECURITY: Pass secret via env var, not shell interpolation
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          # Create MCP config with Linear server
          # SECURITY: Using env var substitution to avoid secret exposure in logs
          cat > /tmp/mcp-config.json << 'MCPEOF'
          {
            "mcpServers": {
              "linear": {
                "url": "https://mcp.linear.app/mcp",
                "transport": "http"
              }
            }
          }
          MCPEOF

          # The Linear API key will be passed via environment variable to Claude Code
          echo "mcp_config_path=/tmp/mcp-config.json" >> "$GITHUB_OUTPUT"

      - name: Run Claude PR Review
        id: review
        uses: anthropics/claude-code-action@v1
        env:
          # SECURITY: Pass Linear API key as env var for MCP authentication
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          # Custom instructions from comment - passed via env to avoid shell injection
          CUSTOM_INSTRUCTIONS: ${{ steps.instructions.outputs.custom_instructions }}
          LINEAR_ISSUE_ID: ${{ steps.linear.outputs.linear_id }}
          PR_NUMBER: ${{ github.event.issue.number }}
          COMMENTER: ${{ github.event.comment.user.login }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}

          # Claude Code plugins for enhanced review capabilities
          plugins: |
            pr-review-toolkit@claude-plugins-official
            superpowers@claude-plugins-official

          # Enable progress tracking for visibility
          track_progress: true

          # Bot identity for commits/comments
          bot_name: claude[bot]

          # Include inline comment links
          include_fix_links: true

          # Comprehensive review prompt
          # SECURITY: User-provided instructions passed via CUSTOM_INSTRUCTIONS env var
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: $PR_NUMBER
            COMMENTER: @$COMMENTER
            LINEAR ISSUE: $LINEAR_ISSUE_ID

            ## Custom Reviewer Instructions

            Check the environment variable CUSTOM_INSTRUCTIONS. If it contains non-empty text,
            treat those as priority instructions from the reviewer who triggered this review.

            ## Your Role

            You are an expert code reviewer for Quantivly, a healthcare technology company building HIPAA-compliant analytics software. Conduct a comprehensive code review with thorough first-pass feedback to minimize developer round-trips.

            ## Review Standards

            Read the review standards from `.github-org/docs/review-standards.md` - these define severity levels, checklists, and output format.

            Also read `.github-org/CLAUDE.md` and the repository's `CLAUDE.md` (if it exists) for project-specific guidelines.

            ## Review Priorities

            1. **Linear Requirement Validation** - If LINEAR_ISSUE_ID is specified, validate PR aligns with requirements
            2. **Security Analysis (CRITICAL)** - OWASP Top 10, HIPAA compliance, SQL injection, XSS, credentials
            3. **Logic Errors and Bugs** - Incorrect implementations, edge cases, race conditions
            4. **Code Quality** - Readability, SOLID principles, design patterns
            5. **Testing Completeness** - Coverage, edge cases, test quality
            6. **Performance** - N+1 queries, algorithmic efficiency, caching

            ## Healthcare Context

            Quantivly builds healthcare analytics software. Extra scrutiny for:
            - PHI handling and encryption
            - Audit logging for data access
            - Access controls and authentication
            - HIPAA compliance

            ## Tools Available

            Use these tools for your review:
            - `gh pr diff $PR_NUMBER` - View the full PR diff
            - `gh pr view $PR_NUMBER` - Get PR metadata
            - `mcp__github_inline_comment__create_inline_comment` - Post inline comments on specific lines
            - `gh pr comment $PR_NUMBER` - Post summary comment
            - Read/Grep/Glob - Explore repository context

            If you have access to Linear MCP tools (mcp__linear__*), use them to fetch issue details
            when LINEAR_ISSUE_ID is set.

            ## Review Process

            1. Read the PR diff and understand the changes
            2. If Linear issue specified, fetch requirements and validate alignment
            3. Analyze each file for security, bugs, and quality issues
            4. Use `mcp__github_inline_comment__create_inline_comment` for specific line-level feedback
            5. Post a summary comment using `gh pr comment` with:
               - Overall assessment
               - Linear alignment (if applicable)
               - Issue counts by severity
               - Positive observations
               - Testing assessment
               - Recommendation: APPROVE, REQUEST_CHANGES, or COMMENT

            ## Output Guidelines

            - Use severity labels: **[CRITICAL]**, **[HIGH]**, **[Suggestion]**
            - CRITICAL = security vulnerabilities, data loss, complete breakage
            - HIGH = bugs, logic errors, missing error handling
            - Suggestion = improvements, refactoring opportunities
            - Be specific with file:line references
            - Explain WHY something is an issue
            - Provide actionable fixes with code examples
            - Don't flag formatting/linting (pre-commit handles that)

            ## Footer

            End your summary with:
            ---
            <sub>Triggered by @$COMMENTER | Powered by Claude Code | [Learn more](https://github.com/quantivly/.github/blob/master/docs/claude-integration-guide.md)</sub>

          # Tool access configuration
          claude_args: |
            --mcp-config /tmp/mcp-config.json
            --allowedTools "mcp__github_inline_comment__create_inline_comment,mcp__linear__*,Bash(gh pr *),Bash(gh api *),Read,Grep,Glob,LS"

      - name: Post error message on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          # Use App token if available, fall back to GITHUB_TOKEN
          github-token: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const errorMessage = `âŒ Claude review failed

            The review encountered an error. This could be due to:
            - API rate limits or timeouts
            - Invalid PR state
            - Configuration issues

            Please check the [workflow run logs](${runUrl}) for details.

            You can try again by commenting \`@claude\` on this PR.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: errorMessage
            });

      - name: Report usage metrics
        if: always()
        env:
          # SECURITY: Using env vars for any dynamic content
          PR_NUM: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
          COMMENTER: ${{ github.event.comment.user.login }}
          RUN_ID: ${{ github.run_id }}
          JOB_STATUS: ${{ job.status }}
          LINEAR_ID: ${{ steps.linear.outputs.linear_id }}
        run: |
          # SECURITY: Using env vars instead of direct GitHub context interpolation
          echo "### Claude Review Metrics" >> "$GITHUB_STEP_SUMMARY"
          echo "- PR: #$PR_NUM" >> "$GITHUB_STEP_SUMMARY"
          echo "- Repository: $REPO" >> "$GITHUB_STEP_SUMMARY"
          echo "- Triggered by: @$COMMENTER" >> "$GITHUB_STEP_SUMMARY"
          echo "- Workflow run: $RUN_ID" >> "$GITHUB_STEP_SUMMARY"
          echo "- Status: $JOB_STATUS" >> "$GITHUB_STEP_SUMMARY"
          echo "- Linear Issue: ${LINEAR_ID:-N/A}" >> "$GITHUB_STEP_SUMMARY"
