name: Claude PR Review

on:
  # Direct trigger for PRs in this (.github) repository
  issue_comment:
    types: [created]

  # Reusable workflow trigger for other repositories in the organization
  workflow_call:
    secrets:
      ANTHROPIC_API_KEY:
        required: true
        description: Anthropic API key for Claude API access
      LINEAR_API_KEY:
        required: false
        description: Linear API key for issue context retrieval
      CLAUDE_APP_PRIVATE_KEY:
        required: false
        description: GitHub App private key for posting reviews as Claude[bot]

# Note: Concurrency control is handled by the caller workflow

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  claude-review:
    # Run on workflow_call (caller already filtered) or direct PR comments from humans
    if: |
      github.event_name == 'workflow_call' ||
      (github.event.issue.pull_request &&
       contains(github.event.comment.body, '@claude') &&
       github.event.comment.user.type != 'Bot')

    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Validate commenter permissions
        id: validate
        uses: actions/github-script@v7
        with:
          script: |
            const commenter = context.payload.comment.user.login;
            const repo = context.repo;

            // Try org membership first
            try {
              await github.rest.orgs.checkMembershipForUser({
                org: repo.owner,
                username: commenter,
              });
              console.log(`✓ ${commenter} is organization member`);
              return true;
            } catch (orgError) {
              // Check if repo collaborator with write access
              try {
                const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                  owner: repo.owner,
                  repo: repo.repo,
                  username: commenter,
                });
                if (['write', 'admin', 'maintain'].includes(permission.permission)) {
                  console.log(`✓ ${commenter} is collaborator with ${permission.permission} access`);
                  return true;
                }
              } catch (e) {}
              console.log(`✗ ${commenter} does not have sufficient permissions`);
              return false;
            }

      - name: Post permission denied
        if: steps.validate.outputs.result == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '⚠️ Claude reviews are only available to organization members and repository collaborators with write access.'
            });

      - name: Exit if permission denied
        if: steps.validate.outputs.result == 'false'
        run: exit 0

      - name: Generate GitHub App token
        id: app-token
        if: vars.CLAUDE_APP_ID != ''
        uses: actions/create-github-app-token@v2
        continue-on-error: true
        with:
          app-id: ${{ vars.CLAUDE_APP_ID }}
          private-key: ${{ secrets.CLAUDE_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout .github repository for review standards
        uses: actions/checkout@v4
        with:
          repository: quantivly/.github
          path: .github-org
          sparse-checkout: |
            docs/review-standards.md
          fetch-depth: 1

      - name: Extract Linear issue ID
        id: linear
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            const match = pr.title.match(/^([A-Z]+-\d+)/);
            core.setOutput('linear_id', match ? match[1] : '');
            console.log(match ? `Linear issue: ${match[1]}` : 'No Linear issue ID in PR title');

      - name: Extract custom instructions
        id: instructions
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.comment.body;
            const match = body.match(/@claude\b[,:]?\s*(.*)/is);
            if (!match) {
              core.setOutput('custom', '');
              return;
            }
            let instructions = match[1].trim();
            const generic = ['', 'review', 'please review', 'review this', 'please review this', 'review this pr', 'please review this pr'];
            if (generic.includes(instructions.toLowerCase())) {
              core.setOutput('custom', '');
              return;
            }
            // Truncate to prevent prompt stuffing
            if (instructions.length > 2000) {
              instructions = instructions.substring(0, 2000) + '... (truncated)';
            }
            core.setOutput('custom', instructions);

      - name: Create MCP config for Linear
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          # Create .mcp.json with explicit auth headers for Linear MCP server
          # The Linear plugin provides tools, but GitHub Actions needs explicit Bearer auth
          # (locally, Claude Code auto-injects auth from env vars)
          if [ -n "$LINEAR_API_KEY" ]; then
            printf '{"mcpServers":{"linear":{"type":"http","url":"https://mcp.linear.app/mcp","headers":{"Authorization":"Bearer %s"}}}}' "$LINEAR_API_KEY" > .mcp.json
            echo "Created .mcp.json with Linear MCP server auth configuration"
          else
            echo "LINEAR_API_KEY not set, skipping MCP config"
          fi

      - name: Run Claude PR Review
        uses: anthropics/claude-code-action@v1
        env:
          # Linear plugin uses this env var for API authentication
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          track_progress: true
          # Add official plugin marketplace (not pre-configured in GitHub Actions)
          plugin_marketplaces: https://github.com/anthropics/claude-plugins-official.git
          # Linear plugin provides tools + domain knowledge
          # .mcp.json provides explicit auth headers needed in GitHub Actions
          # (locally, Claude Code auto-injects auth from LINEAR_API_KEY env var)
          plugins: linear@claude-plugins-official
          # Enable MCP servers from .mcp.json (provides auth that plugin config lacks)
          settings: '{"enableAllProjectMcpServers": true}'
          # Allow tools for PR review:
          # - Action's built-in GitHub tools (inline comments, PR operations)
          # - Linear MCP tools (issue context, requirements) via plugin
          # - gh CLI for PR content, metadata, and cross-repo access
          # - File tools for reading codebase
          # - git for commit history context
          claude_args: |
            --allowedTools "mcp__github_inline_comment__*,mcp__github_comment__*,mcp__linear__*,Bash(gh pr *),Bash(gh api *),Bash(git log *),Bash(git show *),Bash(git diff *),Read,Glob,Grep,LS"
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.issue.number }}
            LINEAR ISSUE: ${{ steps.linear.outputs.linear_id || 'Not specified' }}
            CUSTOM FOCUS: ${{ steps.instructions.outputs.custom || 'None - standard review' }}

            ## Your Role

            You are an expert code reviewer for Quantivly, a healthcare technology company building HIPAA-compliant analytics software.

            ## Quantivly Architecture

            Two-layer architecture: platform provides foundational data infrastructure, hub provides user-facing analytics portal.

            **platform** (quantivly-dockers) - Core DICOM/RIS backbone
            | Component | Role | Depends On |
            |-----------|------|------------|
            | box | DICOM harmonization (GE/Philips/Siemens), RIS integration | quantivly-sdk |
            | ptbi | DICOM networking (Python+Java/dcm4che) | quantivly-sdk |
            | auto-conf | Jinja2 stack generator (configures platform AND hub) | — |
            | quantivly-sdk | Python SDK for platform services | — |

            **hub** (hub repo) - Healthcare analytics portal
            | Repository | Role | Depends On |
            |------------|------|------------|
            | sre-core | Django backend (GraphQL API, plugin system) | sre-sdk |
            | sre-ui | Next.js frontend | sre-core GraphQL |
            | sre-event-bridge | WAMP→REST bridge | sre-sdk |
            | sre-postgres | PostgreSQL database | — |
            | sre-sdk | Python SDK for hub services | — |

            **Connection**: Hub integrates with platform's backbone (Keycloak auth, WAMP router, shared networking). Platform's auto-conf generates deployment configs for both ecosystems.

            ## Review Standards

            Read `.github-org/docs/review-standards.md` for severity levels, checklists, and output format.
            Also read the repository's `CLAUDE.md` if it exists.

            ## Linear Integration

            If a Linear issue ID is provided, use the Linear MCP tools to:
            1. Fetch the issue description and acceptance criteria
            2. Review any comments for additional requirements
            3. Validate the PR implementation aligns with requirements
            4. Flag any gaps between requirements and implementation

            ## Cross-Repository Validation

            When reviewing changes to shared/exported code, validate consumers using `gh api`:

            | Change In | Must Validate Against | Example Check |
            |-----------|----------------------|---------------|
            | sre-core GraphQL schema | sre-ui TypeScript types/queries | `gh api repos/quantivly/sre-ui/contents/src/graphql` |
            | sre-sdk | sre-core, sre-event-bridge | Check imports and API usage |
            | quantivly-sdk | box, ptbi | Check SDK method calls |
            | auto-conf templates | Rendered stack files | Verify Jinja2 renders correctly |

            Use: `gh api repos/quantivly/<repo>/contents/<path>` to fetch files from other repos.

            ## Review Priorities

            1. **Security** - OWASP Top 10, HIPAA compliance, SQL injection, XSS, credentials
            2. **Logic Errors** - Incorrect implementations, edge cases, race conditions
            3. **Code Quality** - Readability, SOLID principles, design patterns
            4. **Testing** - Coverage, edge cases, test quality
            5. **Performance** - N+1 queries, algorithmic efficiency

            ## Healthcare Context

            Extra scrutiny for PHI handling, audit logging, access controls, and HIPAA compliance.

            ## Output

            Use inline comments via `mcp__github_inline_comment__create_inline_comment` for specific issues.
            Post a summary comment with overall assessment and recommendation (APPROVE/REQUEST_CHANGES/COMMENT).

            Use severity labels: **[CRITICAL]**, **[HIGH]**, **[Suggestion]**

            End summary with:
            ---
            <sub>Triggered by @${{ github.event.comment.user.login }} | Powered by Claude Code</sub>

      - name: Post error on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `❌ Claude review failed. Check [workflow logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.\n\nTo retry, post a new comment mentioning Claude.`
            });

      - name: Report usage metrics
        if: always()
        env:
          PR_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
          TRIGGERED_BY: ${{ github.event.comment.user.login }}
          LINEAR_ID: ${{ steps.linear.outputs.linear_id }}
          CUSTOM_INSTRUCTIONS: ${{ steps.instructions.outputs.custom }}
        run: |
          echo "### Claude Review Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- PR: #${PR_NUMBER}" >> $GITHUB_STEP_SUMMARY
          echo "- Repository: ${REPO}" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: @${TRIGGERED_BY}" >> $GITHUB_STEP_SUMMARY
          echo "- Linear Issue: ${LINEAR_ID:-Not specified}" >> $GITHUB_STEP_SUMMARY
          echo "- Custom Focus: ${CUSTOM_INSTRUCTIONS:-Standard review}" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
