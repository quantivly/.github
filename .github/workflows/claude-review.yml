name: Claude PR Review

on:
  # Direct trigger for PRs in this (.github) repository
  issue_comment:
    types: [created]

  # Reusable workflow trigger for other repositories in the organization
  workflow_call:
    secrets:
      ANTHROPIC_API_KEY:
        required: true
        description: Anthropic API key for Claude API access
      LINEAR_API_KEY:
        required: false
        description: Linear API key for issue context retrieval
      CLAUDE_APP_PRIVATE_KEY:
        required: false
        description: GitHub App private key for posting reviews as Claude[bot]

# Note: Concurrency control is handled by the caller workflow

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  claude-review:
    # Run on workflow_call (caller already filtered) or direct PR comments from humans
    if: |
      github.event_name == 'workflow_call' ||
      (github.event.issue.pull_request &&
       contains(github.event.comment.body, '@claude') &&
       github.event.comment.user.type != 'Bot')

    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Validate commenter permissions
        id: validate
        uses: actions/github-script@v7
        with:
          script: |
            const commenter = context.payload.comment.user.login;
            const repo = context.repo;

            // Try org membership first
            try {
              await github.rest.orgs.checkMembershipForUser({
                org: repo.owner,
                username: commenter,
              });
              console.log(`‚úì ${commenter} is organization member`);
              return true;
            } catch (orgError) {
              // Check if repo collaborator with write access
              try {
                const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                  owner: repo.owner,
                  repo: repo.repo,
                  username: commenter,
                });
                if (['write', 'admin', 'maintain'].includes(permission.permission)) {
                  console.log(`‚úì ${commenter} is collaborator with ${permission.permission} access`);
                  return true;
                }
              } catch (e) {}
              console.log(`‚úó ${commenter} does not have sufficient permissions`);
              return false;
            }

      - name: Post permission denied
        if: steps.validate.outputs.result == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '‚ö†Ô∏è Claude reviews are only available to organization members and repository collaborators with write access.'
            });

      - name: Exit if permission denied
        if: steps.validate.outputs.result == 'false'
        run: exit 0

      - name: Generate GitHub App token
        id: app-token
        if: vars.CLAUDE_APP_ID != ''
        uses: actions/create-github-app-token@v2
        continue-on-error: true
        with:
          app-id: ${{ vars.CLAUDE_APP_ID }}
          private-key: ${{ secrets.CLAUDE_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout .github repository for review standards
        uses: actions/checkout@v4
        with:
          repository: quantivly/.github
          path: .github-org
          sparse-checkout: |
            docs/review-standards.md
          fetch-depth: 1

      - name: Extract Linear issue ID
        id: linear
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            const match = pr.title.match(/^([A-Z]+-\d+)/);
            core.setOutput('linear_id', match ? match[1] : '');
            console.log(match ? `Linear issue: ${match[1]}` : 'No Linear issue ID in PR title');

      - name: Extract custom instructions
        id: instructions
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.comment.body;
            const match = body.match(/@claude\b[,:]?\s*(.*)/is);
            if (!match) {
              core.setOutput('custom', '');
              return;
            }
            let instructions = match[1].trim();
            const generic = ['', 'review', 'please review', 'review this', 'please review this', 'review this pr', 'please review this pr'];
            if (generic.includes(instructions.toLowerCase())) {
              core.setOutput('custom', '');
              return;
            }
            // Truncate to prevent prompt stuffing
            if (instructions.length > 2000) {
              instructions = instructions.substring(0, 2000) + '... (truncated)';
            }
            core.setOutput('custom', instructions);

      - name: Create MCP config for Linear
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          # Create .mcp.json with explicit auth headers for Linear MCP server
          # The Linear plugin provides tools, but GitHub Actions needs explicit Bearer auth
          # (locally, Claude Code auto-injects auth from env vars)
          if [ -n "$LINEAR_API_KEY" ]; then
            printf '{"mcpServers":{"linear":{"type":"http","url":"https://mcp.linear.app/mcp","headers":{"Authorization":"Bearer %s"}}}}' "$LINEAR_API_KEY" > .mcp.json
            echo "Created .mcp.json with Linear MCP server auth configuration"
          else
            echo "LINEAR_API_KEY not set, skipping MCP config"
          fi

      - name: Run Claude PR Review
        uses: anthropics/claude-code-action@v1
        env:
          # Linear plugin uses this env var for API authentication
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          track_progress: true
          # Add official plugin marketplace (not pre-configured in GitHub Actions)
          plugin_marketplaces: https://github.com/anthropics/claude-plugins-official.git
          # Plugins:
          # - linear: Issue context and requirements validation
          # - github: Formal review tools (pull_request_review_write, add_comment_to_pending_review)
          # Note: .mcp.json provides explicit auth headers needed for Linear in GitHub Actions
          plugins: |
            linear@claude-plugins-official
            github@claude-plugins-official
          # Enable MCP servers from .mcp.json (provides auth that plugin config lacks)
          settings: '{"enableAllProjectMcpServers": true}'
          # Allow tools for PR review:
          # - GitHub MCP plugin review tools (formal reviews with inline comments)
          # - Linear MCP tools (issue context, requirements) via plugin
          # - gh CLI for PR content, metadata, and cross-repo access
          # - File tools for reading codebase
          # - git for commit history context
          claude_args: |
            --allowedTools "mcp__plugin_github_github__pull_request_review_write,mcp__plugin_github_github__add_comment_to_pending_review,mcp__plugin_github_github__pull_request_read,mcp__plugin_linear_linear__*,Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh api *),Bash(git log *),Bash(git show *),Bash(git diff *),Read,Glob,Grep,LS"
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.issue.number }}
            LINEAR ISSUE: ${{ steps.linear.outputs.linear_id || 'Not specified' }}
            CUSTOM FOCUS: ${{ steps.instructions.outputs.custom || 'None - standard review' }}

            ## Your Role

            You are an expert code reviewer for Quantivly, a healthcare technology company building HIPAA-compliant analytics software.

            ## Review Workflow (CRITICAL - Follow These Steps Exactly)

            You MUST post your review as an actual GitHub review event, NOT a plain comment.

            **Step 1: Create Pending Review**
            Use `mcp__plugin_github_github__pull_request_review_write` with:
            - method: "create"
            - owner: "${{ github.repository_owner }}"
            - repo: "${{ github.event.repository.name }}"
            - pullNumber: ${{ github.event.issue.number }}
            (Do NOT include the "event" parameter yet - this keeps the review pending)

            **Step 2: Add Inline Comments**
            For each specific issue on a line, use `mcp__plugin_github_github__add_comment_to_pending_review`:
            - owner, repo, pullNumber: same as above
            - path: file path relative to repo root
            - body: Your comment with severity prefix (e.g., "üö® **[CRITICAL]** SQL injection vulnerability...")
            - line: The line number in the new version (right side of diff)
            - side: "RIGHT" (comment on new code)
            - subjectType: "LINE"

            Only use inline comments for issues on specific lines. General observations go in the review summary.

            **Step 3: Submit the Review**
            Use `mcp__plugin_github_github__pull_request_review_write` with:
            - method: "submit_pending"
            - owner, repo, pullNumber: same as above
            - event: Choose based on findings:
              - "REQUEST_CHANGES": Has CRITICAL issues that must be fixed
              - "COMMENT": Has HIGH issues or needs clarification
              - "APPROVE": No critical/high issues, only suggestions
            - body: Your review summary (see Output Format below)

            **Step 4: Clean Up Tracking Comment**
            After submitting the review, delete the progress tracking comment:
            ```bash
            COMMENT_ID=$(gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
              --jq '.[] | select(.user.login == "claude[bot]" or .user.login == "github-actions[bot]") | select(.body | startswith("**Claude")) | .id' | head -1)
            if [ -n "$COMMENT_ID" ]; then
              gh api -X DELETE repos/${{ github.repository }}/issues/comments/$COMMENT_ID
            fi
            ```

            ## Quantivly Architecture

            Two-layer architecture: platform provides foundational data infrastructure, hub provides user-facing analytics portal.

            **platform** (quantivly-dockers) - Core DICOM/RIS backbone
            | Component | Role | Depends On |
            |-----------|------|------------|
            | box | DICOM harmonization (GE/Philips/Siemens), RIS integration | quantivly-sdk |
            | ptbi | DICOM networking (Python+Java/dcm4che) | quantivly-sdk |
            | auto-conf | Jinja2 stack generator (configures platform AND hub) | ‚Äî |
            | quantivly-sdk | Python SDK for platform services | ‚Äî |

            **hub** (hub repo) - Healthcare analytics portal
            | Repository | Role | Depends On |
            |------------|------|------------|
            | sre-core | Django backend (GraphQL API, plugin system) | sre-sdk |
            | sre-ui | Next.js frontend | sre-core GraphQL |
            | sre-event-bridge | WAMP‚ÜíREST bridge | sre-sdk |
            | sre-postgres | PostgreSQL database | ‚Äî |
            | sre-sdk | Python SDK for hub services | ‚Äî |

            **Connection**: Hub integrates with platform's backbone (Keycloak auth, WAMP router, shared networking). Platform's auto-conf generates deployment configs for both ecosystems.

            ## Review Standards

            Read `.github-org/docs/review-standards.md` for severity levels, checklists, and output format.
            Also read the repository's `CLAUDE.md` if it exists.

            ## Linear Integration

            If a Linear issue ID is provided, use the Linear MCP tools to:
            1. Fetch the issue description and acceptance criteria
            2. Review any comments for additional requirements
            3. Validate the PR implementation aligns with requirements
            4. Flag any gaps between requirements and implementation

            ## Cross-Repository Validation

            When reviewing changes to shared/exported code, validate consumers using `gh api`:

            | Change In | Must Validate Against | Example Check |
            |-----------|----------------------|---------------|
            | sre-core GraphQL schema | sre-ui TypeScript types/queries | `gh api repos/quantivly/sre-ui/contents/src/graphql` |
            | sre-sdk | sre-core, sre-event-bridge | Check imports and API usage |
            | quantivly-sdk | box, ptbi | Check SDK method calls |
            | auto-conf templates | Rendered stack files | Verify Jinja2 renders correctly |

            Use: `gh api repos/quantivly/<repo>/contents/<path>` to fetch files from other repos.

            ## Review Priorities

            1. **Security** - OWASP Top 10, HIPAA compliance, SQL injection, XSS, credentials
            2. **Logic Errors** - Incorrect implementations, edge cases, race conditions
            3. **Code Quality** - Readability, SOLID principles, design patterns
            4. **Testing** - Coverage, edge cases, test quality
            5. **Performance** - N+1 queries, algorithmic efficiency

            ## Healthcare Context

            Extra scrutiny for PHI handling, audit logging, access controls, and HIPAA compliance.

            ## Output Format

            Your review summary (the `body` parameter when submitting the review) should be concise:

            ---

            **Summary**: [1-2 sentences: what the PR does]

            **Linear**: [Issue ID] - [Status: ‚úÖ Aligned / ‚ö†Ô∏è Gaps / ‚ùå Misaligned]

            **Issues**: [X critical, Y high, Z suggestions] ‚Äî see inline comments

            **Highlights**:
            - ‚úÖ [Notable good practice]
            - ‚úÖ [Another positive]

            ---
            <sub>@${{ github.event.comment.user.login }} ¬∑ [Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>

            ---

            **IMPORTANT**: Keep the summary SHORT. Details belong in inline comments, not the summary.
            Use these severity emojis in inline comments:
            - üö® **[CRITICAL]** - Security, data loss, must fix
            - ‚ö†Ô∏è **[HIGH]** - Bugs, logic errors, should fix
            - üí° **[Suggestion]** - Improvements, nice to have

      - name: Post error on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚ùå Claude review failed. Check [workflow logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.\n\nTo retry, post a new comment mentioning Claude.`
            });

      - name: Report usage metrics
        if: always()
        env:
          PR_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
          TRIGGERED_BY: ${{ github.event.comment.user.login }}
          LINEAR_ID: ${{ steps.linear.outputs.linear_id }}
          CUSTOM_INSTRUCTIONS: ${{ steps.instructions.outputs.custom }}
        run: |
          echo "### Claude Review Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- PR: #${PR_NUMBER}" >> $GITHUB_STEP_SUMMARY
          echo "- Repository: ${REPO}" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: @${TRIGGERED_BY}" >> $GITHUB_STEP_SUMMARY
          echo "- Linear Issue: ${LINEAR_ID:-Not specified}" >> $GITHUB_STEP_SUMMARY
          echo "- Custom Focus: ${CUSTOM_INSTRUCTIONS:-Standard review}" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
